<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCheck - Simple Time Tracking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-card: #1a1a1a;
            --bg-hover: #222222;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent-primary: #00d4ff;
            --accent-secondary: #0099cc;
            --accent-glow: #00d4ff40;
            --border-color: #333333;
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --gradient-primary: linear-gradient(135deg, #00d4ff, #0099cc);
            --gradient-secondary: linear-gradient(135deg, #00d4ff, #00b8e6);
        }

        .light-theme {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-icon {
            width: 2.5rem;
            height: 2.5rem;
            background: var(--gradient-primary);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .nav {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .main {
            padding: 2rem 0;
        }

        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), var(--shadow-glow);
            border-color: var(--accent-primary);
        }

        .landing {
            text-align: center;
            padding: 4rem 0;
        }

        .landing h1 {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            letter-spacing: -0.02em;
        }

        .landing p {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
            font-weight: 400;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .feature-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 1.25rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            text-align: left;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .feature-card:hover::before {
            transform: scaleX(1);
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), var(--shadow-glow);
            border-color: var(--accent-primary);
        }

        .feature-icon {
            width: 4rem;
            height: 4rem;
            background: var(--gradient-primary);
            border-radius: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: var(--shadow-glow);
            position: relative;
        }

        .feature-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: var(--gradient-primary);
            border-radius: 1.5rem;
            z-index: -1;
            opacity: 0.5;
            filter: blur(8px);
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .dashboard {
            display: grid;
            gap: 2rem;
        }

        .timer-section {
            text-align: center;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: 900;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            margin: 2rem 0;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 212, 255, 0.6);
            letter-spacing: -0.02em;
            position: relative;
        }

        .timer-display::after {
            content: '';
            position: absolute;
            inset: -10px;
            background: var(--gradient-primary);
            border-radius: 1rem;
            z-index: -1;
            opacity: 0.1;
            filter: blur(20px);
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .timer-input-group {
            display: flex;
            gap: 1rem;
            align-items: end;
            flex-wrap: wrap;
            justify-content: center;
        }

        .timer-input {
            min-width: 200px;
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), var(--shadow-glow);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .charts-section {
            margin: 2rem 0;
        }

        .chart-container {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            text-align: center;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin: 0 auto;
        }

        .sessions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .session-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .session-item:hover {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        .session-item:last-child {
            border-bottom: none;
        }

        .session-header {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 400px;
            width: 90%;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .session-item, .session-header {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .landing h1 {
                font-size: 2.5rem;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .timer-display {
                font-size: 3rem;
            }
            
            .timer-input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .timer-input {
                min-width: auto;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .chart-wrapper {
                height: 250px;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.6s ease-out;
        }

        .feature-card:nth-child(1) { animation-delay: 0.1s; }
        .feature-card:nth-child(2) { animation-delay: 0.2s; }
        .feature-card:nth-child(3) { animation-delay: 0.3s; }
        .feature-card:nth-child(4) { animation-delay: 0.4s; }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div>Loading...</div>
        </div>

        <!-- Landing Page -->
        <div id="landing" class="hidden">
            <header class="header">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">
                            <div class="logo-icon"></div>
                            <span>FlowCheck</span>
                        </div>
                        <nav class="nav">
                            <a href="#" class="btn btn-secondary" onclick="showPage('login')">Log in</a>
                            <a href="#" class="btn btn-primary" onclick="showPage('signup')">Sign up</a>
                        </nav>
                    </div>
                </div>
            </header>
            <main class="main">
                <div class="container">
                                         <div class="landing">
                         <h1>Simple, effective time tracking</h1>
                         <p>FlowCheck helps you track focused work sessions, visualize your productivity, and export your data with one click. Built for focus, designed for results.</p>
                         <div class="nav">
                             <a href="#" class="btn btn-primary" onclick="showPage('signup')">Get started</a>
                             <a href="#" class="btn btn-secondary" onclick="showPage('login')">I already have an account</a>
                         </div>
                         
                         <div class="features-grid">
                             <div class="feature-card">
                                 <div class="feature-icon">⏱️</div>
                                 <h3>Smart Timer</h3>
                                 <p>Start/stop timer with intelligent inactivity checks. First check at 45 minutes, then every 30 minutes.</p>
                             </div>
                             <div class="feature-card">
                                 <div class="feature-icon">📊</div>
                                 <h3>Real-time Stats</h3>
                                 <p>Track daily and weekly progress with beautiful visualizations and instant insights.</p>
                             </div>
                             <div class="feature-card">
                                 <div class="feature-icon">💾</div>
                                 <h3>Secure Storage</h3>
                                 <p>All your sessions are safely stored in Firebase with automatic backup and sync.</p>
                             </div>
                             <div class="feature-card">
                                 <div class="feature-icon">📤</div>
                                 <h3>Export & Share</h3>
                                 <p>Download your complete session history as CSV for reporting, invoicing, or analysis.</p>
                             </div>
                         </div>
                     </div>
                </div>
            </main>
        </div>

        <!-- Login Page -->
        <div id="login" class="hidden">
            <div class="container">
                <div class="main">
                    <div class="auth-form">
                        <div class="card">
                            <h2 style="margin-bottom: 0.5rem;">Welcome back</h2>
                            <p style="color: #6b7280; margin-bottom: 1.5rem;">Log in to continue tracking your time.</p>
                            <form onsubmit="handleLogin(event)">
                                <div class="form-group">
                                    <label class="label" for="login-email">Email</label>
                                    <input type="email" id="login-email" class="input" required>
                                </div>
                                <div class="form-group">
                                    <label class="label" for="login-password">Password</label>
                                    <input type="password" id="login-password" class="input" required>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%;">Log in</button>
                            </form>
                            <div style="text-align: center; margin-top: 1rem;">
                                <a href="#" onclick="showForgotPassword()" style="color: #4f46e5; font-size: 0.875rem;">Forgot your password?</a>
                            </div>
                            <p style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: #6b7280;">
                                New here? <a href="#" onclick="showPage('signup')" style="color: #4f46e5;">Create an account</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signup" class="hidden">
            <div class="container">
                <div class="main">
                    <div class="auth-form">
                        <div class="card">
                            <h2 style="margin-bottom: 0.5rem;">Create your account</h2>
                            <p style="color: #6b7280; margin-bottom: 1.5rem;">Start tracking your focused work today.</p>
                            <form onsubmit="handleSignup(event)">
                                <div class="form-group">
                                    <label class="label" for="signup-email">Email</label>
                                    <input type="email" id="signup-email" class="input" required>
                                </div>
                                <div class="form-group">
                                    <label class="label" for="signup-password">Password</label>
                                    <input type="password" id="signup-password" class="input" required>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%;">Create account</button>
                            </form>
                            <p style="margin-top: 1rem; text-align: center; font-size: 0.875rem; color: #6b7280;">
                                Already have an account? <a href="#" onclick="showPage('login')" style="color: #4f46e5;">Log in</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <header class="header">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">
                            <div class="logo-icon"></div>
                            <span>FlowCheck</span>
                        </div>
                                                 <nav class="nav">
                             <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
                             <button class="btn btn-secondary" onclick="toggleTheme()" id="theme-toggle">🌙</button>
                             <button class="btn btn-secondary" onclick="handleLogout()">Log out</button>
                         </nav>
                    </div>
                </div>
            </header>
            <main class="main">
                <div class="container">
                    <div class="dashboard">
                                                 <!-- Timer Section -->
                         <div class="card timer-section">
                             <div class="form-group" style="margin-bottom: 1.5rem;">
                                 <label class="label" for="session-description">Session description</label>
                                 <div class="timer-input-group">
                                     <input type="text" id="session-description" class="input timer-input" placeholder="e.g., Writing report, Coding, Research...">
                                     <button id="timer-btn" class="btn btn-primary" onclick="toggleTimer()">Start</button>
                                 </div>
                             </div>
                             <div id="timer-display" class="timer-display">00:00:00</div>
                             <div id="timer-info" style="color: #6b7280; font-size: 0.875rem; font-weight: 500;"></div>
                         </div>

                                                 <!-- Stats Grid -->
                         <div class="stats-grid">
                             <div class="card stat-card">
                                 <div class="stat-value" id="today-total">0h 0m</div>
                                 <div class="stat-label">Today</div>
                             </div>
                             <div class="card stat-card">
                                 <div class="stat-value" id="week-total">0h 0m</div>
                                 <div class="stat-label">This Week</div>
                             </div>
                             <div class="card stat-card">
                                 <div class="stat-value" id="month-total">0h 0m</div>
                                 <div class="stat-label">This Month</div>
                             </div>
                             <div class="card stat-card">
                                 <div class="stat-value" id="total-sessions">0</div>
                                 <div class="stat-label">Total Sessions</div>
                             </div>
                             <div class="card stat-card">
                                 <div class="stat-value" id="avg-session">0m 0s</div>
                                 <div class="stat-label">Avg Session</div>
                             </div>
                             <div class="card stat-card">
                                 <div class="stat-value" id="longest-session">0m 0s</div>
                                 <div class="stat-label">Longest Session</div>
                             </div>
                         </div>

                         <!-- Charts Section -->
                         <div class="charts-section">
                             <div class="chart-container">
                                 <h3 class="chart-title">Weekly Activity</h3>
                                 <div class="chart-wrapper">
                                     <canvas id="weeklyChart"></canvas>
                                 </div>
                             </div>
                             <div class="chart-container">
                                 <h3 class="chart-title">Daily Distribution</h3>
                                 <div class="chart-wrapper">
                                     <canvas id="dailyChart"></canvas>
                                 </div>
                             </div>
                         </div>

                                                 <!-- Sessions List -->
                         <div class="card">
                             <h3 style="margin-bottom: 1.5rem; color: #111827; font-size: 1.25rem;">Recent sessions</h3>
                             <div id="sessions-list" class="sessions-list">
                                 <div style="text-align: center; color: #6b7280; padding: 2rem;">No sessions yet</div>
                             </div>
                         </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Inactivity Modal -->
        <div id="inactivity-modal" class="modal hidden">
            <div class="modal-content">
                <h3 style="margin-bottom: 0.5rem;">Still working?</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;">Confirm within 5 minutes to keep tracking. Otherwise, this session will be discarded.</p>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="discardSession()">Discard</button>
                    <button class="btn btn-primary" onclick="confirmStillWorking()">I'm here</button>
                </div>
            </div>
        </div>

        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal" class="modal hidden">
            <div class="modal-content">
                <h3 style="margin-bottom: 0.5rem;">Reset Password</h3>
                <p style="color: #6b7280; margin-bottom: 1rem;">Enter your email address and we'll send you a link to reset your password.</p>
                <form onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                        <label class="label" for="reset-email">Email</label>
                        <input type="email" id="reset-email" class="input" required>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="hideForgotPassword()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Reset Link</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDoa8YzQ707xRs1IGD3AqdXNMgPwPM2FWA",
            authDomain: "flowcheck-a4412.firebaseapp.com",
            projectId: "flowcheck-a4412",
            storageBucket: "flowcheck-a4412.firebasestorage.app",
            messagingSenderId: "450070719140",
            appId: "1:450070719140:web:52df78d02e59a45ba2d431"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App state
        let currentUser = null;
        let sessions = [];
        let timerInterval = null;
        let startTime = null;
        let nextCheckTime = null;
        let inactivityTimeout = null;
        let isTimerRunning = false;

        // DOM elements
        const loadingEl = document.getElementById('loading');
        const landingEl = document.getElementById('landing');
        const loginEl = document.getElementById('login');
        const signupEl = document.getElementById('signup');
        const dashboardEl = document.getElementById('dashboard');
        const inactivityModalEl = document.getElementById('inactivity-modal');
        const forgotPasswordModalEl = document.getElementById('forgot-password-modal');

        // Initialize app
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                showPage('dashboard');
                loadSessions();
            } else {
                showPage('landing');
            }
            loadingEl.classList.add('hidden');
        });

        // Theme management
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            
            if (body.classList.contains('light-theme')) {
                body.classList.remove('light-theme');
                themeToggle.textContent = '🌙';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-theme');
                themeToggle.textContent = '☀️';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('theme-toggle');
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeToggle.textContent = '☀️';
            }
        }

        // Initialize theme
        loadTheme();

        // Navigation
        function showPage(pageName) {
            [landingEl, loginEl, signupEl, dashboardEl].forEach(el => el.classList.add('hidden'));
            document.getElementById(pageName).classList.remove('hidden');
        }

        // Authentication
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(result.user.uid).set({
                    uid: result.user.uid,
                    email: result.user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                alert('Sign up failed: ' + error.message);
            }
        }

        function handleLogout() {
            auth.signOut();
        }

        // Forgot password functions
        function showForgotPassword() {
            forgotPasswordModalEl.classList.remove('hidden');
            // Pre-fill email if available
            const loginEmail = document.getElementById('login-email').value;
            if (loginEmail) {
                document.getElementById('reset-email').value = loginEmail;
            }
        }

        function hideForgotPassword() {
            forgotPasswordModalEl.classList.add('hidden');
            document.getElementById('reset-email').value = '';
        }

        async function handleForgotPassword(event) {
            event.preventDefault();
            const email = document.getElementById('reset-email').value;
            
            try {
                await auth.sendPasswordResetEmail(email);
                alert('Password reset email sent! Check your inbox for the reset link.');
                hideForgotPassword();
            } catch (error) {
                alert('Failed to send reset email: ' + error.message);
            }
        }

        // Timer functions
        function toggleTimer() {
            if (isTimerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            const description = document.getElementById('session-description').value || 'Focus session';
            startTime = Date.now();
            isTimerRunning = true;
            nextCheckTime = startTime + (45 * 60 * 1000); // 45 minutes
            
            document.getElementById('timer-btn').textContent = 'Stop';
            document.getElementById('session-description').disabled = true;
            
            timerInterval = setInterval(updateTimer, 1000);
            updateTimerInfo();
        }

        function stopTimer(commit = true) {
            if (!isTimerRunning) return;
            
            isTimerRunning = false;
            if (timerInterval) clearInterval(timerInterval);
            
            document.getElementById('timer-btn').textContent = 'Start';
            document.getElementById('session-description').disabled = false;
            document.getElementById('timer-display').textContent = '00:00:00';
            document.getElementById('timer-info').textContent = '';
            
            if (commit && startTime) {
                const endTime = Date.now();
                saveSession({
                    description: document.getElementById('session-description').value || 'Focus session',
                    start: startTime,
                    end: endTime,
                    durationMs: endTime - startTime
                });
                document.getElementById('session-description').value = '';
            }
            
            startTime = null;
            nextCheckTime = null;
            if (inactivityTimeout) clearTimeout(inactivityTimeout);
        }

        function updateTimer() {
            if (!startTime) return;
            
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('timer-display').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Check for inactivity
            if (nextCheckTime && Date.now() >= nextCheckTime) {
                promptInactivity();
            }
        }

        function updateTimerInfo() {
            if (!nextCheckTime) return;
            
            const timeUntilCheck = Math.ceil((nextCheckTime - Date.now()) / 60000);
            const isFirstCheck = nextCheckTime - startTime === 45 * 60 * 1000;
            const interval = isFirstCheck ? 45 : 30;
            
            document.getElementById('timer-info').textContent = 
                `Inactivity check in ${timeUntilCheck} minutes (then every ${interval} minutes)`;
        }

        function promptInactivity() {
            // Browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Still working?', { body: 'Confirm to keep tracking.' });
            }
            
            // Show modal
            inactivityModalEl.classList.remove('hidden');
            
            // Auto-discard after 5 minutes
            inactivityTimeout = setTimeout(() => {
                inactivityModalEl.classList.add('hidden');
                stopTimer(false);
                alert('Session discarded due to inactivity');
            }, 5 * 60 * 1000);
        }

        function confirmStillWorking() {
            inactivityModalEl.classList.add('hidden');
            if (inactivityTimeout) clearTimeout(inactivityTimeout);
            
            const now = Date.now();
            nextCheckTime = now + (30 * 60 * 1000); // 30 minutes
            updateTimerInfo();
        }

        function discardSession() {
            inactivityModalEl.classList.add('hidden');
            stopTimer(false);
        }

        // Session management
        async function saveSession(sessionData) {
            try {
                await db.collection('users').doc(currentUser.uid).collection('sessions').add({
                    ...sessionData,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Session saved!');
                loadSessions();
            } catch (error) {
                alert('Failed to save session: ' + error.message);
            }
        }

        async function loadSessions() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('sessions')
                    .orderBy('start', 'desc')
                    .limit(50)
                    .get();
                
                sessions = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                updateSessionsList();
                updateStats();
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function updateSessionsList() {
            const container = document.getElementById('sessions-list');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 2rem;">No sessions yet</div>';
                return;
            }
            
            const header = `
                <div class="session-header">
                    <div>Description</div>
                    <div>Start Time</div>
                    <div>End Time</div>
                    <div>Duration</div>
                </div>
            `;
            
            const sessionsHtml = sessions.map(session => `
                <div class="session-item">
                    <div style="font-weight: 500;">${session.description}</div>
                    <div>${formatDateTime(session.start)}</div>
                    <div>${formatDateTime(session.end)}</div>
                    <div style="font-weight: 600; color: #4f46e5;">${formatDuration(session.durationMs)}</div>
                </div>
            `).join('');
            
            container.innerHTML = header + sessionsHtml;
        }

        function updateStats() {
            const now = Date.now();
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const todayTotal = sessions
                .filter(s => s.start >= today.getTime())
                .reduce((sum, s) => sum + s.durationMs, 0);
            
            const weekTotal = sessions
                .filter(s => s.start >= weekStart.getTime())
                .reduce((sum, s) => sum + s.durationMs, 0);
            
            const monthTotal = sessions
                .filter(s => s.start >= monthStart.getTime())
                .reduce((sum, s) => sum + s.durationMs, 0);
            
            const totalSessions = sessions.length;
            const avgSession = totalSessions > 0 ? sessions.reduce((sum, s) => sum + s.durationMs, 0) / totalSessions : 0;
            const longestSession = totalSessions > 0 ? Math.max(...sessions.map(s => s.durationMs)) : 0;
            
            document.getElementById('today-total').textContent = formatDuration(todayTotal);
            document.getElementById('week-total').textContent = formatDuration(weekTotal);
            document.getElementById('month-total').textContent = formatDuration(monthTotal);
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('avg-session').textContent = formatDuration(avgSession);
            document.getElementById('longest-session').textContent = formatDuration(longestSession);
            
            updateCharts();
        }

        // Utility functions
        function formatDateTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatDuration(ms) {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Chart variables
        let weeklyChart = null;
        let dailyChart = null;

        function updateCharts() {
            updateWeeklyChart();
            updateDailyChart();
        }

        function updateWeeklyChart() {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;

            if (weeklyChart) {
                weeklyChart.destroy();
            }

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const weekData = days.map((day, index) => {
                const dayStart = new Date();
                dayStart.setDate(dayStart.getDate() - dayStart.getDay() + index);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(dayStart);
                dayEnd.setDate(dayEnd.getDate() + 1);
                
                const dayTotal = sessions
                    .filter(s => s.start >= dayStart.getTime() && s.start < dayEnd.getTime())
                    .reduce((sum, s) => sum + s.durationMs, 0);
                
                return Math.round(dayTotal / 60000); // Convert to minutes
            });

            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Minutes',
                        data: weekData,
                        backgroundColor: 'rgba(0, 212, 255, 0.8)',
                        borderColor: 'rgba(0, 212, 255, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }

        function updateDailyChart() {
            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;

            if (dailyChart) {
                dailyChart.destroy();
            }

            const hours = Array.from({length: 24}, (_, i) => i);
            const hourData = hours.map(hour => {
                const hourTotal = sessions
                    .filter(s => {
                        const sessionHour = new Date(s.start).getHours();
                        return sessionHour === hour;
                    })
                    .reduce((sum, s) => sum + s.durationMs, 0);
                
                return Math.round(hourTotal / 60000); // Convert to minutes
            });

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours.map(h => `${h}:00`),
                    datasets: [{
                        label: 'Minutes',
                        data: hourData,
                        borderColor: 'rgba(0, 212, 255, 1)',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(0, 212, 255, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    }
                }
            });
        }

        function exportCSV() {
            if (sessions.length === 0) {
                alert('No sessions to export');
                return;
            }
            
            const headers = ['Description', 'Start', 'End', 'Duration (seconds)', 'Duration (formatted)'];
            const rows = sessions.map(s => [
                s.description,
                new Date(s.start).toISOString(),
                new Date(s.end).toISOString(),
                Math.round(s.durationMs / 1000),
                formatDuration(s.durationMs)
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'flowcheck_sessions.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
